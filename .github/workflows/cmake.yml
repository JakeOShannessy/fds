on: [push, pull_request]

name: CMake Build

jobs:
  build:
    name: ${{ matrix.os }} - openmp=${{ matrix.openmp }} - mkl=${{ matrix.mkl }} - ${{ matrix.compiler }}
    strategy:
      matrix:
        os:
          - ubuntu-latest
        compiler:
          - gcc
          - intel
        openmp:
          - on
          - off
        mkl:
          # - on
          - off
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v2
      - name: Add intel apt repo
        if: matrix.compiler == 'intel'
        run: |
          wget https://apt.repos.intel.com/intel-gpg-keys/GPG-PUB-KEY-INTEL-SW-PRODUCTS.PUB
          sudo apt-key add GPG-PUB-KEY-INTEL-SW-PRODUCTS.PUB
          sudo add-apt-repository "deb https://apt.repos.intel.com/oneapi all main"
          sudo apt-get update
      - name: Install prerequisites
        if: matrix.compiler == 'intel'
        run: sudo apt-get install -y intel-basekit intel-hpckit
      - name: Install prerequisites
        if: matrix.compiler == 'gcc'
        run: sudo apt-get install openmpi-bin
      - name: collect versioned dependencies of apt packages
        if: matrix.compiler == 'intel'
        run : |
          # oneapi-ci/scripts/apt_depends.sh
          apt-cache depends intel-oneapi-compiler-fortran \
                            intel-oneapi-mpi-devel \
                            intel-oneapi-mkl-devel | tee dependencies.txt
      - name: cache install
        id: cache-install
        if: matrix.compiler == 'intel'
        uses: actions/cache@v2
        with:
          path: /opt/intel/oneapi
          key: install-${{ hashFiles('**/dependencies.txt') }}
      - name: install
        if: steps.cache-install.outputs.cache-hit != 'true' && matrix.compiler == 'intel'
        run: |
          # oneapi-ci/scripts/install_linux_apt.sh
          sudo apt-get install -y intel-oneapi-compiler-fortran \
                                  intel-oneapi-mpi-devel \
                                  intel-oneapi-mkl-devel
          sudo apt-get clean
      - name: Set compiler (${{ matrix.compiler }})
        if: matrix.compiler == 'intel'
        shell: bash
        run: |
          echo "FC=mpiifort" >> $GITHUB_ENV
      - name: Set compiler (${{ matrix.compiler }})
        if: matrix.compiler == 'gcc'
        shell: bash
        run: |
          echo "FC=mpifort" >> $GITHUB_ENV
      - name: Build (${{ matrix.compiler }})
        run: |
          source /opt/intel/oneapi/setvars.sh || true
          cmake -B ${{github.workspace}}/cbuild -S .
          cmake --build ${{github.workspace}}/cbuild
      - name: Test
        shell: bash
        working-directory: ${{github.workspace}}/cbuild
        run: |
          source /opt/intel/oneapi/setvars.sh || true
          ctest -j10 --output-on-failure
